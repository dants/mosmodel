MODULE_NAME := experiments/growing_window_2m
GROWING_WINDOW_MODULE_NAME := $(MODULE_NAME)

NUM_OF_GROWING_WINDOW_CONFIGURATIONS := 9
$(MODULE_NAME)/%: NUM_OF_GROWING_WINDOW_CONFIGURATIONS := $(NUM_OF_GROWING_WINDOW_CONFIGURATIONS)
GROWING_WINDOW_CONFIGURATIONS := \
	$(call configuration_array,$(NUM_OF_GROWING_WINDOW_CONFIGURATIONS))
SUBMODULES := $(addprefix $(MODULE_NAME)/,$(GROWING_WINDOW_CONFIGURATIONS))

GROWING_WINDOW_CONFIGURATION_MAKEFILES := $(addsuffix /module.mk,$(SUBMODULES))
$(GROWING_WINDOW_CONFIGURATION_MAKEFILES): $(MODULE_NAME)/configuration%/module.mk: \
	$(MOSALLOC_TEMPLATE)
	mkdir -p $(dir $@)
	cp -rf $< $@
	sed -i 's,TEMPLATE_ARG1,$(GROWING_WINDOW_MODULE_NAME),g' $@
	sed -i 's,TEMPLATE_ARG2,$*,g' $@

PER_BENCHMARK_TARGETS := $(addprefix $(MODULE_NAME)/,$(INTERESTING_BENCHMARKS))

$(PER_BENCHMARK_TARGETS): $(MODULE_NAME)/%: $(addsuffix /%,$(SUBMODULES))
	echo "Finished running all growing_window_configurations of benchmark $*: $^"

GROWING_WINDOW_CONFIGURATION_FILES := $(addprefix $(MODULE_NAME)/,$(INTERESTING_BENCHMARKS))
GROWING_WINDOW_CONFIGURATION_FILES := $(addsuffix /configurations.txt,$(GROWING_WINDOW_CONFIGURATION_FILES))
CREATE_GROWING_WINDOW_CONFIGURATIONS_SCRIPT := $(MODULE_NAME)/createConfigurations.py
GROWING_WINDOW_CONFIGURATION_OUTPUT_DIR := $(MODULE_NAME)

#TODO: move the memory_footprints dependecy to MEMORY_FOOTPRINTS_FILE with secondary expansion
$(GROWING_WINDOW_CONFIGURATION_FILES): $(MODULE_NAME)/%/configurations.txt: analysis/single_page_size/memory_footprints.csv
	mkdir -p $(dir $@)
	$(CREATE_GROWING_WINDOW_CONFIGURATIONS_SCRIPT) --memory_footprints=$(MEMORY_FOOTPRINTS_FILE) \
		--num_configurations=$(NUM_OF_GROWING_WINDOW_CONFIGURATIONS) \
		--benchmark $* --output_dir=$(GROWING_WINDOW_CONFIGURATION_OUTPUT_DIR)

DELETE_TARGETS := $(addsuffix /delete,$(GROWING_WINDOW_CONFIGURATION_FILES) \
	$(GROWING_WINDOW_CONFIGURATION_MAKEFILES))
$(MODULE_NAME)/clean: $(DELETE_TARGETS)

include $(ROOT_DIR)/common.mk

